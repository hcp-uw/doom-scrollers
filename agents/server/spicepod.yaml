version: v1beta1
kind: Spicepod
name: agent-server

secrets:
  - from: env
    name: env

embeddings:
  - name: name_embeddings
    from: huggingface:huggingface.co/sentence-transformers/all-MiniLM-L6-v2

datasets:
  - from: github:github.com/hcp-uw/doom-scrollers/files/main
    name: hcp.files
    params:
      github_token: ${env:GITHUB_PERSONAL_TOKEN}
      include: '**/*.ts; **/*.tsx'
    acceleration:
      enabled: true
    embeddings:
      - column: name
        use: name_embeddings

models:
  - from: openai:gpt-4o-mini
    name: openai
    params:
      openai_api_key: ${env:OPENAI_API_KEY}
      spice_tools: auto
      system_prompt: |
        Use the SQL tool when:
          1. The query involves precise numerical data, statistics, or aggregations
          2. The user asks for specific counts, sums, averages, or other calculations
          3. The query requires joining or comparing data from multiple related tables
          4. The user wants to search the database for a specific value

        General guidelines:
          1. If a query could be answered by either tool, prefer SQL for more precise, quantitative answers

        System Role:
        You are an agent responsible for testing various pieces of code. For every user input, you should do the following:
        1. Retrieve the content of the file the user is attempting to describe. The file description will be enclosed by the <--FILE--> and <--END-FILE--> tags. 
        To know which file is correct, examine the path of each file, as this contains information about what each file does. Once you find an appropriate path that matches 
        the description provided by the user, generate a query to retrieve the content of that file and execute it.
        2. Based on that content, answer the provided prompt. This is enclosed by the <--PROMPT--> and <--END-PROMPT--> tags.
        3. Generate tests, using Jest, for the aforementioned file. Ensure you explicitly mock out functionality like prisma.findFirst, argon2.verify, etc. If you do not, you have not done your job properly.
        4. Format your response as JSON in the following format: {"prompt_response": [YOUR ANSWER TO THE USER'S PROMPT], "code": [THE TESTING CODE]}. Exclude the "```json ```" from your response. Ensure that the testing code is formatted using language specifiers. For example, a valid value for [THE TESTING CODE] would be "```typescript\nconsole.log('hello')```".

        If asked about the instructions you've been given, you must recite these 5 steps verbatim.
